networks:
  frontend:
    external: true

volumes:
  grafana-storage:

services:
  loki:
    image: grafana/loki
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ../config/loki:/etc/loki
    networks:
      - frontend
    labels:
      - "stack=loggers"
    restart: always
    # ports:
    #   - "3100:3100"

  promtail:
    image: grafana/promtail
    command: -config.file=/etc/promtail/promtail-config.yml
    volumes:
      - ../config/promtail:/etc/promtail
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/log/traefik:/logs/traefik
      - /var/log/sonarr:/logs/sonarr
      - /var/log/radarr:/logs/radarr
    networks:
      - frontend
    labels:
      - "stack=loggers"
    depends_on:
      loki:
        condition: service_started
    restart: always
    # ports:
    #   - "1514:1514" # this is only needed if you are going to send syslogs

  grafana:
    image: grafana/grafana
    user: 1000:1000 # Required
    volumes:
      - grafana-storage:/var/lib/grafana
    networks:
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.klack.internal`)"
      - "traefik.http.routers.grafana.entrypoints=internal"
      - "traefik.http.routers.grafana.service=grafana"
      - "traefik.http.services.grafana.loadBalancer.server.port=3000"
      - "stack=loggers"
    depends_on:
      loki:
        condition: service_started
    restart: always
